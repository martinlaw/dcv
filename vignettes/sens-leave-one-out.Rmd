---
title: 'Sensitivity analysis: leave one out'
author: "Martin Law"
date: '2022-07-15'
output: html_document
---
---
title: "Sensitivity analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r library, results="hide", message=FALSE}
library(metafor)
```

## Input data
```{r atelectasis}
dat <- escalc(measure="RR",
              ai=c(3, 5, 2, 0, 1),
              bi=c(32, 39, 43, 15, 24),
              ci=c(6, 7, 4, 1, 2),
              di=c(29, 35, 41, 14, 23),
              slab=c("Mahmoud et al, 2017",
                     "Li et al (Standard), 2020",
                     "Li et al (OLA), 2020",
                     "Ammar et al, 2021",
                     "Yao et al, 2020"))

dat.atelectasis <- escalc(measure="RR",
              ai=c(3, 2, 1, 1, 0),
              bi=c(15, 33, 43, 44, 15),
              ci=c(4, 6, 4, 2, 1),
              di=c(15, 29, 38, 43, 14),
              slab=c("Boules et al, 2011",
                     "Mahmoud et al, 2017",
                     "Li et al (Standard), 2020",
                     "Li et al (OLA), 2020",
                     "Ammar et al, 2021")
              )
```

## Fit models
```{r PM, fig.height=4, fig.width=7}
final.pneu.mod <- rma(yi, vi, data=dat, method="PM") 
final.atel.mod <- rma(yi, vi, data=dat.atelectasis, method="PM") 
```

## Sensitivity analysis: "Leave one out"
### Atelectasis
```{r leave one out atel, fig.height=4, fig.width=7}
leave1.atel <- leave1out(final.atel.mod)
forest.default(x=leave1.atel$estimate, ci.lb=leave1.atel$ci.lb, ci.ub=leave1.atel$ci.ub,
               slab=paste("Omitting ", leave1.atel$slab, sep=""),atransf=exp,
               at=log(c(0.15, 0.25, exp(final.atel.mod$b), 1, 4)), xlim=log(c(0.01, 4.5)),
               refline=final.atel.mod$b
              )
lines(x=log(c(1, 1)), y=c(0, 6))
```

### Pneumonia
```{r leave one out pneu, fig.height=4, fig.width=7}
leave1 <- leave1out(final.pneu.mod)
forest.default(x=leave1$estimate, ci.lb=leave1$ci.lb, ci.ub=leave1$ci.ub,
               slab=paste("Omitting ", leave1$slab, sep=""),atransf=exp,
               at=log(c(0.15, 0.25, exp(final.pneu.mod$b),  1, 4)), xlim=log(c(0.01, 4.5)),
               refline=final.pneu.mod$b
              )
lines(x=log(c(1, 1)), y=c(0, 6))
```

## Subgroup analysis
Data unclear:

* Multiple/range of values given for tidal volume
* No PEEP values greater than zero (dichotomisation is at zero)
* Li et al. results are split in two in the primary outcome, but not clear if tidal volume etc. are the same in both sets of results.

### Tidal volume (>6 vs <=6mL/kg)
### PEEP (<0 vs 0)
### Anesthesia type (TIVA vs inhaled)
