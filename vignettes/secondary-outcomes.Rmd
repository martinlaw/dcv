---
title: "Secondary outcomes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r library, results="hide", message=FALSE}
library(metafor)
library(readxl)
library(here)
```

## Load data
```{r}
initial.data <- read_xlsx(path=here("data/secondary_outcomes-2.xlsx"), range="A1:M48", col_names=TRUE)
#dat <- escalc(measure="MD", data=initial.data, m1i=m1i, sd1i=sd1i, n1i=n1i, m2i=m2i, sd2i=sd2i, n2i=n2i, slab=study)
#
```


## Fig 2: Respiratory compliance (Cdyn)
```{r, Cdyn, fig.height=5, fig.width=7, eval=FALSE}
mod <- rma(yi, vi, data=dat, subset = (outcome1=="Cdyn" & time=="OLV"), method="PM")
forest(mod, header="Cdyn (OLV)", cex=1.5)
```

Evidence of an effect.

## Fig 3: Plateau pressure (Plat)
```{r, plateau, fig.height=5, fig.width=7, eval=FALSE}
mod <- rma(yi, vi, data=dat, subset = (outcome1=="Plat" & time=="TLV"), method="PM")
forest(mod, header="Plateau (TLV)", cex=1.5)
mod <- rma(yi, vi, data=dat, subset = (outcome1=="Plat" & time=="OLV"), method="PM")
forest(mod, header="Plateau (OLV)", cex=1.5)
```

Figure 3 in paper has different headings compared to Figs 4 and 5.
Evidence of effect for OLV only (and not when using HKSJ).

## Fig 4: Peak inspiratory pressure (Peak)
```{r, peak, fig.height=6, fig.width=7, eval=FALSE}
mod <- rma(yi, vi, data=dat, subset = (outcome1=="Peak" & time=="TLV"), method="PM")
forest(mod, header="Peak (TLV)", cex=1.5)
mod <- rma(yi, vi, data=dat, subset = (outcome1=="Peak" & time=="OLV"), method="PM")
forest(mod, header="Peak (OLV)", cex=1.5)
```
Fig 4 has TLV first, while Figs 3 and 5 have OLV first.
Evidence of effect for both TLV and OLV (even with HKSJ).

## Fig 5: Arterial oxygen pressure (pO2)
```{r, arterial, fig.height=6, fig.width=7, eval=FALSE}
mod <- rma(yi, vi, data=dat, subset = (outcome1=="pO2" & time=="TLV"), method="PM")
forest(mod, header="pO2 (TLV)", cex=1.5)
# mod <- rma(yi, vi, data=dat, subset = (outcome1=="pO2" & time=="OLV"), method="PM")
# Error when using default options. Fix:
mod <- rma(yi, vi, data=dat, subset = outcome1=="pO2" & time=="OLV", method="PM", control=list(tau2.max=1000))
forest(mod, header="pO2 (OLV)", cex=1.5)
```
TLV and OLV data have been mixed up in the document (assuming the Excel sheet is correct)
Evidence of effect for both TLV and OLV (even with HKSJ).

NOTE: Using HKSJ modification has negligible effect on results, just one exception: Plateau+OLV summary estimate is not significant when using HKSJ modification.
